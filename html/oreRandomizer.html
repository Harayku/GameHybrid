<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ore Randomizer</title>
    <link href="https://fonts.cdnfonts.com/css/arcade-classic" rel="stylesheet" />

    <style>
        :root {
            --bg-spot: #c2c2c2;
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            margin: 0;
        }

        body {
            font-family: "ArcadeClassic";
            background: radial-gradient(var(--bg));
            color: #e5e7eb;
            display: grid;
            place-items: center;
            padding: 24px;
        }

        .card {
            width: min(92vw, 420px);
            border-radius: 16px;
            padding: 28px;
        }

        .frame {
            width: 280px;
            height: 280px;
            margin: 0 auto;
            display: grid;
            place-items: center;
            overflow: hidden;
            cursor: pointer;
            position: relative;
            user-select: none;
            -webkit-user-drag: none;
            transition: box-shadow 200ms ease, border-color 200ms ease;
        }

        /* Spin Animation */
        @keyframes spin {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
            }
        }
            
        #oreImg {
            width: 75%;
            height: 75%;
            object-fit: contain;
            image-rendering: auto;
            transition: transform 120ms ease, filter 120ms ease, opacity 200ms ease;
            will-change: transform, filter;
            opacity: 0.98;
            animation: spin 2s;
            animation-iteration-count: infinite;
        }

        /* Fast phase: subtle punch-in + micro blur for speed feel */
        .spinning {
            transform: scale(1.5);
        }
    </style>
</head>

<body>
    <div class="card">
        <div id="oreFrame" class="frame" title="Click to spin">
            <img id="oreImg" alt="Ore" src="" />
        </div>
    </div>

    <script>
        const ORE_IMAGES = [
            "../Assets/Ores/dyamante.png",
            "../Assets/Ores/esmeralda.png",
            "../Assets/Ores/ginto.png",
            "../Assets/Ores/bakal.png",
            "../Assets/Ores/tanso.png",
            "../Assets/Ores/uling.png"
        ];

        // Theme per ore same index with ORE_IMAGES
        const ORE_THEME = [
            { bg: "#00e1ff" }, // dyamante
            { bg: "#00ff2a" }, // esmeralda
            { bg: "#fbff00" }, // ginto
            { bg: "#a0a0a0" }, // bakal
            { bg: "#d6640c" }, // tanso
            { bg: "#0b0b0c" }, // uling
        ];

        const frame = document.getElementById("oreFrame");
        const imgEl = document.getElementById("oreImg");

        let currentIndex = 0;
        let spinning = false;

        // Preload to keep the fast phase smooth
        function preloadImages(sources) {
            return Promise.all(
                sources.map(src => new Promise(resolve => {
                    const i = new Image();
                    i.onload = i.onerror = resolve; // keep going even if a URL fails
                    i.src = src;
                }))
            );
        }

        function mod(a, b) { return ((a % b) + b) % b; }

        function hexToRgba(hex, alpha) {
            let h = hex.replace('#', '');
            if (h.length === 3) {
                h = h.split('').map(c => c + c).join('');
            }
            const r = parseInt(h.slice(0, 2), 16);
            const g = parseInt(h.slice(2, 4), 16);
            const b = parseInt(h.slice(4, 6), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        function applyTheme(idx) {
            const t = ORE_THEME[idx % ORE_THEME.length];
            if (!t) return;
            const root = document.documentElement;
            root.style.setProperty('--bg', t.bg);
        }

        // Decelerating spinner to a random target index, with live color theming
        function spin() {
            if (spinning || ORE_IMAGES.length === 0) return;
            spinning = true;
            frame.classList.add("spinning");

            // Choose a truly random final result
            const targetIndex = Math.floor(Math.random() * ORE_IMAGES.length);

            // Ensure at least several full rotations before easing to the target
            const minCycles = 3; // complete cycles
            let stepsRemaining = minCycles * ORE_IMAGES.length + mod(targetIndex - currentIndex, ORE_IMAGES.length);

            // Start brisk, then ease out
            let delay = 50; // ms between ticks (fast phase)
            const tick = () => {
                currentIndex = (currentIndex + 1) % ORE_IMAGES.length;
                imgEl.src = ORE_IMAGES[currentIndex] || PLACEHOLDER;

                // Update theme to match the currently shown ore while spinning
                applyTheme(currentIndex);

                stepsRemaining--;

                if (stepsRemaining <= 0) {
                    // Finalize on target (keep the final theme)
                    applyTheme(targetIndex);
                    spinning = false;
                    frame.classList.remove("spinning");
                    return;
                }

                // Deceleration curve: increase delay more as we approach the end
                if (stepsRemaining < ORE_IMAGES.length * 2) {
                    delay += 26; // final crawl
                } else if (stepsRemaining < ORE_IMAGES.length * 4) {
                    delay += 13; // mid slow
                } else {
                    delay += 10;  // gentle slowdown during fast phase
                }

                setTimeout(tick, delay);
            };

            setTimeout(tick, delay);
        }

        // Initial setup
        (async () => {
            imgEl.src = ORE_IMAGES[0] || PLACEHOLDER;
            applyTheme(0); // set initial theme to first ore
            await preloadImages(ORE_IMAGES);
            // Click/tap to spin
            frame.addEventListener("click", spin, { passive: true });
        })();
    </script>
</body>

</html>